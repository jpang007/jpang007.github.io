<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Consent Management Test</title>
</head>
<body>
<h1>What is your favorite place to travel?</h1>
<p>I am building a directory of the sweetest travel destinations.</p>

<form id="travelForm">
  What is your favorite travel destination?
  <input name="destination" required size="81" type="text"/> 
  <br><br><br> 
  Any recommendations? 
  <br><br> 
  <textarea cols="81" name="details" rows="10"></textarea> 
  <br><br> 
  Name: <input name="fullname" required size="75" type="text"/> 
  <br><br> 
  Email: <input name="email" required size="75" type="email"/> 
  <br><br>
  <input type="submit" value="Submit"/>
</form>

<!-- 1. Simulate a very basic CMP -->
<script>
  window.CMP = {
    ConsentModel: 'opt-in', // or 'opt-out'
    consentedCategories: () => ({ marketing: true, analytics: true }),
    categories: ['marketing', 'analytics'],
    popUpVisible: () => false,
    onConsentChanged: (callback) => {
      // For simulation, you can call this manually later
      window.simulateConsentChange = (newCategories) => {
        callback({ detail: newCategories })
      }
    }
  }
</script>

<!-- 2. Load the wrapper and analytics -->
<script type="module">
  import { createWrapper, resolveWhen } from 'https://cdn.skypack.dev/@segment/analytics-consent-tools'
  import { AnalyticsBrowser } from 'https://cdn.skypack.dev/@segment/analytics-next'

  // Your wrapper
  const normalizeCategories = (categories) => {
    return categories
  }

  const withCMP = createWrapper({
    shouldLoadWrapper: async () => {
      await resolveWhen(() => window.CMP !== undefined, 500)
    },
    shouldLoadSegment: async (ctx) => {
      if (window.CMP.ConsentModel === 'opt-out') {
        return ctx.load({ consentModel: 'opt-out' })
      } else {
        await resolveWhen(
          () => !window.CMP.popUpVisible() && window.CMP.categories.length,
          500
        )
        return ctx.load({ consentModel: 'opt-in' })
      }
    },
    getCategories: () => {
      return normalizeCategories(window.CMP.consentedCategories())
    },
    registerOnConsentChanged: (setCategories) => {
      window.CMP.onConsentChanged((event) => {
        setCategories(normalizeCategories(event.detail))
      })
    }
  })

  // Create the Analytics instance
  const analytics = new AnalyticsBrowser()

  // Attach with consent wrapper
  await withCMP(analytics).load({ writeKey: 'MSEyvX1MNFogVw1n6O2qxijFWnfzcvBy' })

  // Now wire up your form submission
  document.getElementById('travelForm').addEventListener('submit', (e) => {
    e.preventDefault()
    const form = e.target
    const email = form.email.value
    const fullname = form.fullname.value
    const destination = form.destination.value
    const details = form.details.value

    analytics.identify(email, {
      email,
      name: fullname,
    })

    analytics.track('destination submitted', {
      destination,
      details,
      email,
      name: fullname
    })
  })
</script>

</body>
</html>
