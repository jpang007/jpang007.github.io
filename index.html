<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Segment Dynamic Write Key Test</title>

  <script>
    // ----------------------------
    // CONFIG
    // ----------------------------
    const DEFAULT_WRITE_KEY = "xJo2vbqhKIjLteoA3czivgUpSYdFmZjz";
    const PARTNER_WRITE_KEY = "wvV6IfoJNsMHAuGRuriQRwbLNOWm2M2n";

    // Simple routing logic
    function getWriteKey() {
      const params = new URLSearchParams(window.location.search);
      return params.get("partner") === "true"
        ? PARTNER_WRITE_KEY
        : DEFAULT_WRITE_KEY;
    }

    const SELECTED_WRITE_KEY = getWriteKey();
    console.log("Using Segment write key:", SELECTED_WRITE_KEY);

    // ----------------------------
    // SEGMENT SNIPPET (unaltered)
    // ----------------------------
    !function(){
      var analytics=window.analytics=window.analytics||[];
      if(!analytics.initialize)
        if(analytics.invoked)
          window.console && console.error && console.error("Segment snippet included twice.");
        else {
          analytics.invoked=!0;
          analytics.methods=[
            "trackSubmit","trackClick","trackLink","trackForm","pageview",
            "identify","reset","group","track","ready","alias","debug",
            "page","screen","once","off","on","addSourceMiddleware",
            "addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware","register"
          ];
          analytics.factory=function(method){
            return function(){
              var args=Array.prototype.slice.call(arguments);
              args.unshift(method);
              analytics.push(args);
              return analytics;
            };
          };
          for(var i=0;i<analytics.methods.length;i++){
            var key=analytics.methods[i];
            analytics[key]=analytics.factory(key);
          }
          analytics.load=function(key,options){
            var script=document.createElement("script");
            script.type="text/javascript";
            script.async=!0;
            script.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";
            var first=document.getElementsByTagName("script")[0];
            first.parentNode.insertBefore(script, first);
            analytics._loadOptions=options;
          };
          analytics.SNIPPET_VERSION="5.2.0";
          analytics.load(SELECTED_WRITE_KEY);
          analytics.page();
        }
    }();
  </script>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    button { margin-right: 10px; }
    code { background: #f4f4f4; padding: 2px 6px; }
  </style>
</head>

<body>
  <h1>Segment Dynamic Write Key Test</h1>

  <p>
    Current mode:
    <strong>
      <script>
        document.write(
          SELECTED_WRITE_KEY === PARTNER_WRITE_KEY
            ? "Partner Source"
            : "Default Source"
        );
      </script>
    </strong>
  </p>

  <p>
    Try loading with:
    <br />
    <code>?partner=true</code> → Partner source
    <br />
    <code>(no param)</code> → Default source
  </p>

  <hr />

  <button onclick="identifyUser()">Identify User</button>
  <button onclick="trackEvent()">Track Event</button>

  <script>
    function identifyUser() {
      analytics.identify("test@example.com", {
        email: "test@example.com",
        onboarding_type:
          SELECTED_WRITE_KEY === PARTNER_WRITE_KEY ? "partner" : "default"
      });
      alert("Identify sent");
    }

    function trackEvent() {
      analytics.track("Button Clicked", {
        source_type:
          SELECTED_WRITE_KEY === PARTNER_WRITE_KEY ? "partner" : "default",
        timestamp: new Date().toISOString()
      });
      alert("Track sent");
    }
  </script>
</body>
</html>
